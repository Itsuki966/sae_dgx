# ğŸ§  Feedbackè¿åˆæ€§åˆ†æ

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€LLMãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ã«å¿œç­”ã‚’å¤‰åŒ–ã•ã›ã‚‹ã‹ï¼ˆè¿åˆæ€§: Sycophancyï¼‰ã‚’ã€SAEï¼ˆSparse Autoencoderï¼‰ã®å†…éƒ¨çŠ¶æ…‹ã‚’ä½¿ç”¨ã—ã¦åˆ†æã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [å‡¦ç†ã®æµã‚Œ](#å‡¦ç†ã®æµã‚Œ)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
  - [Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ](#pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ)
  - [Jupyter Notebookç‰ˆ](#jupyter-notebookç‰ˆ)
- [è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º](#è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º)
- [å‡ºåŠ›æ§‹é€ ](#å‡ºåŠ›æ§‹é€ )
- [ãƒ‡ãƒ¼ã‚¿å½¢å¼](#ãƒ‡ãƒ¼ã‚¿å½¢å¼)
- [è§£æä½ç½®ã«ã¤ã„ã¦](#è§£æä½ç½®ã«ã¤ã„ã¦)

---

## æ¦‚è¦

### ğŸ¯ ç›®çš„

Feedbackãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã‚’åˆ†æã—ã¾ã™ï¼š

1. **è¿åˆçš„å¿œç­”ã®æ¤œå‡º**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã«åŸºã¥ã„ã¦å¿œç­”ã‚’å¤‰åŒ–ã•ã›ã‚‹å‚¾å‘
2. **SAEå†…éƒ¨çŠ¶æ…‹ã®å–å¾—**: å¿œç­”ç”Ÿæˆæ™‚ã®ãƒ¢ãƒ‡ãƒ«ã®å†…éƒ¨è¡¨ç¾ã‚’è¨˜éŒ²
3. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–“ã®æ¯”è¼ƒ**: 5ç¨®é¡ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã®å¿œç­”å·®ç•°ã‚’åˆ†æ

### ğŸ” åˆ†æå¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼

- **Layer 9**: åˆæœŸçš„ãªç‰¹å¾´æŠ½å‡º
- **Layer 20**: ä¸­é–“å±¤ã®æ„å‘³è¡¨ç¾
- **Layer 31**: æœ€çµ‚å±¤ã®å‡ºåŠ›æ±ºå®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

### ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

`eval_dataset/feedback.jsonl`ã«ã¯ã€ä»¥ä¸‹ã®3ç¨®é¡ã®ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¾ã™ï¼š

- **arguments**: è­°è«–ãƒ»ä¸»å¼µã«å¯¾ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
- **poems**: è©©ã«å¯¾ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯  
- **math**: æ•°å­¦å•é¡Œã®è§£æ³•ã«å¯¾ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

å„è³ªå•ã«å¯¾ã—ã¦5ç¨®é¡ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã™ï¼š

1. **base**: ä¸­ç«‹çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
2. **I really like**: ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
3. **I really dislike**: ãƒã‚¬ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
4. **I like / This is great**: åˆ¥ã®ãƒã‚¸ãƒ†ã‚£ãƒ–è¡¨ç¾
5. **I dislike / This is bad**: åˆ¥ã®ãƒã‚¬ãƒ†ã‚£ãƒ–è¡¨ç¾

---

## å‡¦ç†ã®æµã‚Œ

```mermaid
graph TD
    A[ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿] --> B[ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–]
    B --> C[ãƒ¢ãƒ‡ãƒ«ãƒ»SAEãƒ­ãƒ¼ãƒ‰]
    C --> D[å„è³ªå•ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‡¦ç†]
    D --> E{5ã¤ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³}
    E --> F[ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ]
    F --> G[å¿œç­”ç”Ÿæˆ]
    G --> H[SAEæ´»æ€§åŒ–å–å¾—]
    H --> I[çµæœè¨˜éŒ²]
    I --> J{æ¬¡ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³}
    J -->|ã‚ã‚Š| E
    J -->|ãªã—| K{æ¬¡ã®è³ªå•}
    K -->|ã‚ã‚Š| D
    K -->|ãªã—| L[çµæœä¿å­˜]
    L --> M[JSON/CSVå‡ºåŠ›]
```

### è©³ç´°ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒ‡ãƒ¼ã‚¿æº–å‚™** (feedback_analyzer.py: `load_feedback_data`)
   - `feedback.jsonl`ã‹ã‚‰è³ªå•ã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
   - 5ã¤ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–

2. **ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–** (`load_model_and_sae`)
   - HookedTransformerã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
   - å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®SAEã‚’ãƒ­ãƒ¼ãƒ‰

3. **å¿œç­”ç”Ÿæˆã¨SAEå–å¾—** (`generate_with_sae`)
   - **A. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³**: å¿œç­”ç”Ÿæˆç›´å‰ã®å†…éƒ¨çŠ¶æ…‹ï¼ˆæ„å›³ãƒ»è¨ˆç”»ï¼‰
   - **B. å¿œç­”ã®æœ€åˆã®æ•°ãƒˆãƒ¼ã‚¯ãƒ³**: è¿åˆçš„å¿œç­”ã®å®Ÿè¡Œãƒ»ç¶­æŒçŠ¶æ…‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

4. **ç‰¹å¾´æŠ½å‡º** 
   - æ´»æ€§åŒ–å€¤ãŒ0ã‚ˆã‚Šå¤§ãã„å…¨SAEç‰¹å¾´ã‚’è¨˜éŒ²ï¼ˆç–ãƒ™ã‚¯ãƒˆãƒ«å½¢å¼ï¼‰
   - Top-kç‰¹å¾´ã‚’ãƒ­ã‚°ãƒ»å¯è¦–åŒ–ç”¨ã«æŠ½å‡º

5. **çµæœä¿å­˜** (`save_results`)
   - JSONå½¢å¼ã§è©³ç´°ãªçµæœã‚’ä¿å­˜
   - CSVå½¢å¼ã§ã‚µãƒãƒªãƒ¼ã‚’ä¿å­˜

---

## ä½¿ç”¨æ–¹æ³•

### Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ

#### åŸºæœ¬çš„ãªä½¿ç”¨æ–¹æ³•

```bash
python run_feedback_analysis.py
```

#### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•

`run_feedback_analysis.py`ã®`main()`é–¢æ•°å†…ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰æ›´ï¼š

```python
# ãƒ™ãƒ¼ã‚¹è¨­å®šã‚’é¸æŠ
base_config = FEEDBACK_GEMMA2_9B_IT_LAYER20_CONFIG  # Layer 20
# base_config = FEEDBACK_GEMMA2_9B_IT_LAYER9_CONFIG  # Layer 9
# base_config = FEEDBACK_GEMMA2_9B_IT_CONFIG  # Layer 31

# åˆ†æç¯„å›²
start = 0    # é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0-basedï¼‰
end = 100    # çµ‚äº†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0-basedï¼‰

# å®Ÿé¨“è¨­å®š
config = setup_experiment_config(
    base_config=base_config,
    save_all_tokens=False,           # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ï¼ˆæ¨å¥¨ï¼‰
    max_new_tokens=512,              # ç”Ÿæˆã™ã‚‹æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    temperature=0.7,                 # ç”Ÿæˆæ¸©åº¦
    response_tokens_to_capture=8     # å¿œç­”ãƒˆãƒ¼ã‚¯ãƒ³æ•°
)
```

### Jupyter Notebookç‰ˆ

Google Colabç’°å¢ƒã§ã®å®Ÿè¡Œç”¨ï¼š

1. **ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**
   ```python
   # Google Driveãƒã‚¦ãƒ³ãƒˆ
   from google.colab import drive
   drive.mount('/content/drive')
   
   # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹è¨­å®š
   PROJECT_PATH = '/content/drive/MyDrive/sae_pj2'
   ```

2. **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š**
   ```python
   start = 0
   end = 100
   SAVE_ALL_TOKENS = False
   MAX_NEW_TOKENS = 512
   TEMPERATURE = 0.7
   ```

3. **åˆ†æå®Ÿè¡Œ**
   ```python
   analyzer = FeedbackAnalyzer(EXPERIMENT_CONFIG)
   analyzer.run_complete_analysis(start_index=start, end_index=end)
   ```

---

## è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ä¸»è¦ãªè¨­å®šé …ç›®

#### 1. ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠ

```python
# config.pyã‹ã‚‰é¸æŠ
FEEDBACK_GEMMA2_9B_IT_CONFIG          # Layer 31 (16k features)
FEEDBACK_GEMMA2_9B_IT_LAYER20_CONFIG  # Layer 20 (131k features)
FEEDBACK_GEMMA2_9B_IT_LAYER9_CONFIG   # Layer 9 (131k features)
```

#### 2. ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ãƒ¢ãƒ¼ãƒ‰

```python
# FeedbackConfig
save_all_tokens: bool = False  # False: æœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ï¼ˆæ¨å¥¨ï¼‰
                               # True: å…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒˆãƒ¼ã‚¯ãƒ³
response_tokens_to_capture: int = 8  # å¿œç­”ã®æœ€åˆã®8ãƒˆãƒ¼ã‚¯ãƒ³
```

#### 3. ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

```python
# GenerationConfig
max_new_tokens: int = 512      # æœ€å¤§ç”Ÿæˆãƒˆãƒ¼ã‚¯ãƒ³æ•°
temperature: float = 0.7       # ç”Ÿæˆæ¸©åº¦ï¼ˆ0.0-1.0ï¼‰
do_sample: bool = True         # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æœ‰åŠ¹åŒ–
top_p: float = 0.9            # Nucleus sampling
top_k: int = 50               # Top-k sampling
```

#### 4. åˆ†æç¯„å›²

```python
# æ–¹æ³•1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŒ‡å®š
start_index = 0     # é–‹å§‹ä½ç½®ï¼ˆ0-basedï¼‰
end_index = 100     # çµ‚äº†ä½ç½®ï¼ˆ0-basedï¼‰

# æ–¹æ³•2: ã‚µãƒ³ãƒ—ãƒ«æ•°æŒ‡å®šï¼ˆå»ƒæ­¢äºˆå®šï¼‰
# sample_size = 100
```

---

## å‡ºåŠ›æ§‹é€ 

### 1. ãƒ¡ã‚¤ãƒ³JSONå‡ºåŠ›

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `results/feedback/feedback_analysis_layer{XX}_q{start}-{end}_{timestamp}.json`

```json
{
  "metadata": {
    "model_name": "gemma-2-9b-it",
    "sae_release": "gemma-scope-9b-it-res-canonical",
    "sae_id": "layer_20/width_131k/canonical",
    "num_questions": 100,
    "question_id_range": {
      "start": 0,
      "end": 100,
      "total_processed": 100
    },
    "error_recovery": false,
    "save_all_tokens": false,
    "response_tokens_captured": 8,
    "analysis_position": {
      "prompt": "prompt_last_token (å¿œç­”ç”Ÿæˆç›´å‰ã®æ„å›³)",
      "response": "æœ€åˆã®8ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆè¿åˆçš„å¿œç­”ã®å®Ÿè¡Œãƒ»ç¶­æŒï¼‰"
    },
    "target_layer": "layer_20",
    "timestamp": "2025-12-21T10:30:00"
  },
  "results": [
    {
      "question_id": 0,
      "dataset": "arguments",
      "base_text": "è­°è«–ã®ãƒ†ã‚­ã‚¹ãƒˆ...",
      "timestamp": "2025-12-21T10:30:15",
      "variations": [
        {
          "template_type": "base",
          "prompt": "å®Œå…¨ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆ...",
          "response_text": "ç”Ÿæˆã•ã‚ŒãŸå¿œç­”...",
          "sae_activations": {
            "prompt_last_token": {
              "15": 0.523,
              "1024": 3.217,
              "2048": 1.853
            },
            "response_token_0": {
              "23": 0.412,
              "2048": 1.853
            },
            "response_token_1": { ... }
          },
          "top_k_features": [
            [1024, 3.217],
            [2048, 1.853],
            [15, 0.523]
          ],
          "metadata": {
            "generation_time_ms": 1234.56,
            "response_length": 256,
            "timestamp": "2025-12-21T10:30:15"
          }
        }
        // æ®‹ã‚Š4ã¤ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³...
      ]
    }
    // æ®‹ã‚Šã®è³ªå•...
  ]
}
```

### 2. ã‚µãƒãƒªãƒ¼CSVå‡ºåŠ›

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `results/feedback/feedback_analysis_summary.csv`

```csv
question_id,dataset,template_type,response_length,num_active_features,top_feature_id,top_feature_value,generation_time_ms
0,arguments,base,256,342,1024,3.217,1234.56
0,arguments,I really like,289,378,1024,3.892,1456.78
0,arguments,I really dislike,234,298,2048,4.123,1123.45
...
```

### 3. å®Ÿé¨“ãƒ­ã‚°

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `experiment_log_{timestamp}.json`

```json
{
  "experiment_start": "2025-12-21T10:30:00",
  "experiment_end": "2025-12-21T12:45:30",
  "execution_time_seconds": 8130.5,
  "config_params": {
    "model_name": "gemma-2-9b-it",
    "save_all_tokens": false,
    "target_layer": "layer_20",
    "temperature": 0.7,
    "max_new_tokens": 512
  },
  "results": {
    "num_questions": 100,
    "total_variations": 500
  },
  "initial_memory_gb": 2.34,
  "final_memory_gb": 3.21
}
```

---

## ãƒ‡ãƒ¼ã‚¿å½¢å¼

### SAEæ´»æ€§åŒ–ã®ä¿å­˜å½¢å¼

#### ç–ãƒ™ã‚¯ãƒˆãƒ«å½¢å¼ï¼ˆSparse Vectorï¼‰

æ´»æ€§åŒ–å€¤ãŒ0ã‚ˆã‚Šå¤§ãã„ç‰¹å¾´ã®ã¿ã‚’è¨˜éŒ²ï¼š

```python
{
  "prompt_last_token": {
    "feature_id": activation_value,  # æ–‡å­—åˆ—ã‚­ãƒ¼: floatå€¤
    "15": 0.523,
    "1024": 3.217
  },
  "response_token_0": {
    "23": 0.412,
    "2048": 1.853
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ãŒé«˜ã„ï¼ˆ0ã§ãªã„å€¤ã®ã¿ä¿å­˜ï¼‰
- MLå­¦ç¿’ï¼ˆXGBoostç­‰ï¼‰ã¨ã®äº’æ›æ€§ãŒé«˜ã„
- SHAPåˆ†æã§å…¨ç‰¹å¾´ã®å¯„ä¸åº¦ã‚’æ­£ç¢ºã«è©•ä¾¡å¯èƒ½

### ãƒˆãƒ¼ã‚¯ãƒ³ä½ç½®ã®å‘½åè¦å‰‡

| ã‚­ãƒ¼ | èª¬æ˜ | åˆ†æç›®çš„ |
|-----|------|---------|
| `prompt_last_token` | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³ | å¿œç­”ç”Ÿæˆç›´å‰ã®æ„å›³ãƒ»è¨ˆç”»çŠ¶æ…‹ |
| `response_token_0` | å¿œç­”ã®1ãƒˆãƒ¼ã‚¯ãƒ³ç›® | è¿åˆçš„å¿œç­”ã®å®Ÿè¡Œé–‹å§‹ |
| `response_token_1` | å¿œç­”ã®2ãƒˆãƒ¼ã‚¯ãƒ³ç›® | è¿åˆçš„å¿œç­”ã®ç¶­æŒ |
| `response_token_N` | å¿œç­”ã®N+1ãƒˆãƒ¼ã‚¯ãƒ³ç›® | ç¶™ç¶šçš„ãªè¿åˆè¡Œå‹• |

---

## è§£æä½ç½®ã«ã¤ã„ã¦

### ğŸ¯ A. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆå¿œç­”ç”Ÿæˆç›´å‰ï¼‰

**å–å¾—ä½ç½®**: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€å¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³

**æ„å‘³**: ãƒ¢ãƒ‡ãƒ«ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨ä½“ã‚’å‡¦ç†ã—çµ‚ãˆãŸç›´å¾Œã®å†…éƒ¨çŠ¶æ…‹

**åˆ†æç›®çš„**: 
- å¿œç­”ç”Ÿæˆå‰ã®ã€Œæ„å›³ãƒ»è¨ˆç”»ã€ã‚’æ‰ãˆã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã©ã®ã‚ˆã†ã«è§£é‡ˆã—ãŸã‹
- è¿åˆã™ã‚‹ã€Œæ–¹é‡ã€ãŒæ±ºå®šã•ã‚Œã‚‹ç¬é–“

**è¨­å®š**:
```python
save_all_tokens = False  # æœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ï¼ˆæ¨å¥¨ï¼‰
```

### ğŸ’¬ B. å¿œç­”ã®æœ€åˆã®æ•°ãƒˆãƒ¼ã‚¯ãƒ³

**å–å¾—ä½ç½®**: ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã®æœ€åˆã®æ•°ãƒˆãƒ¼ã‚¯ãƒ³

**æ„å‘³**: è¿åˆçš„å¿œç­”ã®ã€Œå®Ÿè¡Œãƒ»ç¶­æŒã€çŠ¶æ…‹

**åˆ†æç›®çš„**:
- å®Ÿéš›ã®è¿åˆè¡Œå‹•ã®ç¢ºèª
- æ„å›³ã¨å®Ÿè¡Œã®ä¸€è²«æ€§ã‚’æ¤œè¨¼
- ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆéç¨‹ã§ã®å†…éƒ¨çŠ¶æ…‹å¤‰åŒ–

**è¨­å®š**:
```python
response_tokens_to_capture = 8  # æœ€åˆã®8ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
```

### æ¨å¥¨è¨­å®š

**æ¨™æº–åˆ†æ**:
```python
save_all_tokens = False           # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€çµ‚ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿
response_tokens_to_capture = 8    # å¿œç­”ã®æœ€åˆã®8ãƒˆãƒ¼ã‚¯ãƒ³
```

**è©³ç´°åˆ†æ**ï¼ˆãƒ¡ãƒ¢ãƒªå¤§å®¹é‡æ™‚ï¼‰:
```python
save_all_tokens = True            # å…¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒˆãƒ¼ã‚¯ãƒ³
response_tokens_to_capture = 16   # å¿œç­”ã®æœ€åˆã®16ãƒˆãƒ¼ã‚¯ãƒ³
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `CUDA out of memory`

**è§£æ±ºç­–**:
1. ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¤‰æ›´ï¼ˆLayer 31 â†’ Layer 20 â†’ Layer 9ï¼‰
2. ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’æ¸›ã‚‰ã™
3. `response_tokens_to_capture`ã‚’æ¸›ã‚‰ã™

```python
# è»½é‡è¨­å®šä¾‹
config.feedback.response_tokens_to_capture = 3
end_index = 50  # ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚’æ¸›ã‚‰ã™
```

### ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„

**ç—‡çŠ¶**: `ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`

**è§£æ±ºç­–**:
```bash
# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å­˜åœ¨ç¢ºèª
ls eval_dataset/feedback.jsonl

# ãƒ‘ã‚¹ã®ç¢ºèª
pwd
```

### ç”ŸæˆãŒé…ã„

**ç—‡çŠ¶**: å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã‚‹

**è§£æ±ºç­–**:
```python
# ç”Ÿæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´
config.generation.max_new_tokens = 256  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ512ã‹ã‚‰å‰Šæ¸›
config.generation.temperature = 0.0     # æ±ºå®šçš„ç”Ÿæˆã§é«˜é€ŸåŒ–
config.generation.do_sample = False
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **MLå­¦ç¿’**: ä¿å­˜ã•ã‚ŒãŸSAEæ´»æ€§åŒ–ãƒ‡ãƒ¼ã‚¿ã§XGBoostãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´
2. **SHAPåˆ†æ**: è¿åˆæ€§ã«å¯„ä¸ã™ã‚‹ç‰¹å¾´ã‚’ç‰¹å®š
3. **ä»‹å…¥å®Ÿé¨“**: ç‰¹å®šã•ã‚ŒãŸç‰¹å¾´ã‚’æ“ä½œã—ã¦å¿œç­”ã‚’åˆ¶å¾¡

é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
- `README_intervention.md`: ä»‹å…¥å®Ÿé¨“ã®è©³ç´°
- `README_sae_activation_extraction.md`: SAEæ´»æ€§åŒ–æŠ½å‡ºã®æŠ€è¡“è©³ç´°

---

## å‚è€ƒæƒ…å ±

### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- **transformer-lens**: HookedTransformer
- **sae-lens**: SAE (Sparse Autoencoder)
- **PyTorch**: æ·±å±¤å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `feedback_analyzer.py`: ãƒ¡ã‚¤ãƒ³åˆ†æã‚¯ãƒ©ã‚¹
- `run_feedback_analysis.py`: ã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
- `feedback_sycophancy_analysis.ipynb`: Jupyter Notebookç‰ˆ
- `config.py`: è¨­å®šç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

- `eval_dataset/feedback.jsonl`: Feedbackãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆ3ç¨®é¡Ã—è¤‡æ•°è³ªå•Ã—5ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ21æ—¥
